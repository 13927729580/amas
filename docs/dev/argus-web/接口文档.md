# API接口


## 接口来源

1. OpenTSDB数据库
    - port：4242
    - 官网接口文档：
        + [HTTP API](http://opentsdb.net/docs/build/html/api_http/index.html)

2. 告警server
    - port：4252
    
3. 采集管理server
    - port：4262



## 总体概况



## 监控

### 拉取指标名列表
----
- 请求数据源：OpenTSDB
- 请求方法：GET
- URI：/api/suggest
- 参数：
    - type：必填，这里应该为metrics
    - max：选填，返回的指标个数，默认值是25
    - q：选填，指标前缀匹配条件，默认为空
- 示例：
    
    > curl http://localhost:4242/api/suggest?type=metrics  
    ["a.b.c", "a.d.e", "f.g"]
    
    > curl http://localhost:4242/api/suggest?type=metrics&max=1  
    ["a.b.c", "a.d.e"]
    
    > curl http://localhost:4242/api/suggest?type=metrics&q=f  
    ["f.g"]
 

### 拉取TAG的key/value
----
- 请求数据源：OpenTSDB
- 请求方法：GET
- URI：/api/suggest
- 参数：
    - type：必填，这里应该为tagk/tagv
    - max：选填，返回的指标个数，默认值是25
    - q：选填，指标前缀匹配条件，默认为空
- 示例：
    
    > curl http://localhost:4242/api/suggest?type=tagk  
    ["host", "name"]
    
    > curl http://localhost:4242/api/suggest?type=tagv  
    ["web01", "web02", "eacon", "jack", "mike"]
     
    
### 聚合函数/取样函数
----
- 请求数据源：OpenTSDB
- 请求方法：GET
- URI：/api/aggregators
- 示例：

    > curl http://localhost:4242/api/aggregators  
    ["mult","p90","zimsum","mimmax","sum","p50","none","p95","ep99r7","p75","p99","ep99r3","ep95r7","min","avg","ep75r7","dev","ep95r3","ep75r3","ep50r7","ep90r7","mimmin","p999","ep50r3","ep90r3","ep999r7","last","max","count","ep999r3","first"]


### 获取监控数据
----
- 请求数据源：OpenTSDB
- 请求方法：GET
- URI：/api/query
- 示例：

    > curl http://10.17.35.43:4242/api/query?start=2d-ago&m=sum:1h-sum:test.m.a  
    [{"metric":"test.m.a","tags":{"host":"eacon"},"aggregateTags":[],"dps":{"1503730800":8847.0,"1503734400":9327.0,"1503738000":8929.0,"1503741600":9359.0,"1503745200":8707.0,"1503748800":8769.0,"1503752400":9061.0,"1503756000":8928.0,"1503759600":9027.0,"1503763200":9053.0,"1503766800":9124.0,"1503770400":8949.0,"1503774000":8291.0,"1503777600":9249.0,"1503781200":8546.0,"1503784800":9197.0,"1503788400":9260.0,"1503792000":9078.0,"1503795600":8914.0,"1503799200":9321.0,"1503802800":9095.0,"1503806400":8771.0,"1503810000":8984.0,"1503813600":9487.0,"1503817200":8867.0,"1503820800":8950.0,"1503824400":9167.0,"1503828000":9145.0,"1503831600":8972.0,"1503835200":9075.0,"1503838800":9037.0,"1503842400":9029.0,"1503846000":9017.0,"1503849600":8804.0,"1503853200":8944.0,"1503856800":9329.0,"1503860400":9240.0,"1503864000":8840.0,"1503867600":9021.0,"1503871200":9416.0,"1503874800":9177.0,"1503878400":9212.0,"1503882000":8854.0,"1503885600":8978.0,"1503889200":8398.0,"1503892800":8968.0,"1503896400":9145.0,"1503900000":966.0}}]

- 返回内容说明：
    + 返回的是一个json数组，每个元素是一个对象字典，包含：
        + metric：指标名
        + tags：指标的分组tag
        + aggregateTags：自动聚合的tag
        + dps：由 __时间戳:数值__ 键值对组成的时间序列数值（用于渲染出折线图）
- URL拼接规则：
    + ```http://{host}:{port}/api/query?start=<开始时间>&end=<结束时间>&m=<聚合函数>:<取样规则>:<指标名><分组tag>```
    + start和end，开始时间和结束时间，由整个监控视图的时间范围决定
        + end可不填，默认为当前时间
        + 转化为时间戳格式
    + 取样规则可不填，形如```<数值><时间单位>-<取样函数>```
        + 如用户选取了取样规则为```1 小时 sum```，则为：```1h-sum```；对应的时间单位如下：
            + 秒：s
            + 分钟：m
            + 小时：h
            + 天：d
            + 周：w
            + 月：n
            + 年：y
    + 分组tag可不填，opentsdb会自动聚合所有tag；
        + 如果有填tag，如a=b，则为```{a=b}```；
        + 如有多个tag，用","分割，如```{a=b,c=d}```；
            
            




## 告警
### /api/alert/strategy


## 采集管理


